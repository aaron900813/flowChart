###########################################################################
#   Makefile for the HRcPCI3501 device driver (Linux)
###########################################################################

FIXUPFLAGS:=$(shell ./fixupflags.sh)
KERNELREV=$(shell uname -r)
KERNELBASE=/lib/modules/$(KERNELREV)
KERNELSRC=$(KERNELBASE)/build
INCLUDEDIR=$(KERNELSRC)/include
VERSION_FILE=/usr/include/linux/version.h
HRCPCI3501_MODDIR=$(KERNELBASE)/HRcPCI3501
HRCPCI3501_BOOT=/etc/rc.d/init.d
HRCPCI3501_BOOT3=/etc/rc.d/rc3.d/S50HRcPCI3501
HRCPCI3501_BOOT5=/etc/rc.d/rc5.d/S50HRcPCI3501


# Extract version number from headers
VER = -DKERN$(shell awk '/LINUX/ {printf("%X", $$3/256)}' $(VERSION_FILE) )

CFLAGS = -D__KERNEL__ -DMODULE -DMODVERSIONS $(VER) -DEXPORT_SYMTAB -O -Wall \
         -I$(INCLUDEDIR) \
         -include $(KERNELSRC)/include/linux/modversions.h \
         $(FIXUPFLAGS)

# What we are building
OBJS = HRcPCI3501.o

HFILES = datatypes.h      \
         type.h     \
         device.h     \
         device.h      \
         pci_ioctl.h      

all: $(OBJS)

HRCPCI3501.o: driver.o pci_io.o pci_init.o
	$(LD) -r $^ -o $@

driver.o:   $(HFILES) Makefile driver.c
pci_io.o:     $(HFILES) Makefile pci_io.c
pci_init.o:  $(HFILES) Makefile pci_init.c

install: all
	install -d ${HRCPCI3501_MODDIR}
	install -m0644 -p HRCPCI3501.o ${HRCPCI3501_MODDIR}
	install -m0755 -p cpci3501_init ${HRCPCI3501_BOOT}/rfm2g_init
	install -m0755 -p cpci3501_load ${HRCPCI3501_BOOT}/rfm2g_load
	install -m0755 -p cpci3501_unload ${HRCPCI3501_BOOT}/rfm2g_unload
	ln -f -s ../init.d/cpci3501_init ${HRCPCI3501_BOOT3}
	ln -f -s ../init.d/cpci3501_init ${HRCPCI3501_BOOT5}
	sh ../cpci3501_load

# Clean up intermediate files
clean:
	rm -f *.o core
#
uninstall: clean
	sh cpci3501_unload
	rm -f ${HRCPCI3501_MODDIR}/HRCPCI3501.o
	rm -f ${HRCPCI3501_BOOT3}
	rm -f ${HRCPCI3501_BOOT5}
	rm -f ${HRCPCI3501_BOOT}/cpci3501_init
	rm -f ${HRCPCI3501_BOOT}/cpci3501_load
	rm -f ${HRCPCI3501_BOOT}/cpci3501_unload
	rmdir ${HRCPCI3501_MODDIR}







