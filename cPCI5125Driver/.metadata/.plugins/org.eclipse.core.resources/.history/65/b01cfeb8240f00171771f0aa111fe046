###########################################################################
#   Makefile for the HRcPCI5125 device driver (Linux)
###########################################################################

FIXUPFLAGS:=$(shell ./fixupflags.sh)
KERNELREV=$(shell uname -r)
KERNELBASE=/lib/modules/$(KERNELREV)
KERNELSRC=$(KERNELBASE)/build
INCLUDEDIR=$(KERNELSRC)/include
VERSION_FILE=/usr/include/linux/version.h
HRCPCI5125_MODDIR=$(KERNELBASE)/HRcPCI5125
HRCPCI5125_BOOT=/etc/rc.d/init.d
HRCPCI5125_BOOT3=/etc/rc.d/rc3.d/S50cPCI5125
HRCPCI5125_BOOT5=/etc/rc.d/rc5.d/S50cPCI5125


# Extract version number from headers
VER = -DKERN$(shell awk '/LINUX/ {printf("%X", $$3/256)}' $(VERSION_FILE) )

CFLAGS = -D__KERNEL__ -DMODULE -DMODVERSIONS $(VER) -DEXPORT_SYMTAB -O -Wall \
         -I$(INCLUDEDIR) \
         -include $(KERNELSRC)/include/linux/modversions.h \
         $(FIXUPFLAGS)

# What we are building
OBJS = HRcPCI5125.o

HFILES = cpci5125driverlnx.h    

all: $(OBJS)

HRCPCI5125.o: driver.o pci_io.o pci_init.o
	$(LD) -r $^ -o $@

driver.o:   $(HFILES) Makefile driver.c
pci_io.o:     $(HFILES) Makefile pci_io.c
pci_init.o:  $(HFILES) Makefile pci_init.c

install: all
	install -d ${HRCPCI5125_MODDIR}
	install -m0644 -p HRCPCI5125.o ${HRCPCI5125_MODDIR}
	install -m0755 -p cpci5125_init ${HRCPCI5125_BOOT}/rfm2g_init
	install -m0755 -p cpci5125_load ${HRCPCI5125_BOOT}/rfm2g_load
	install -m0755 -p cpci5125_unload ${HRCPCI5125_BOOT}/rfm2g_unload
	ln -f -s ../init.d/cpci5125_init ${HRCPCI5125_BOOT3}
	ln -f -s ../init.d/cpci5125_init ${HRCPCI5125_BOOT5}
	sh ../cpci5125_load

# Clean up intermediate files
clean:
	rm -f *.o core
#
uninstall: clean
	sh cpci5125_unload
	rm -f ${HRCPCI5125_MODDIR}/HRCPCI5125.o
	rm -f ${HRCPCI5125_BOOT3}
	rm -f ${HRCPCI5125_BOOT5}
	rm -f ${HRCPCI5125_BOOT}/cpci5125_init
	rm -f ${HRCPCI5125_BOOT}/cpci5125_load
	rm -f ${HRCPCI5125_BOOT}/cpci5125_unload
	rmdir ${HRCPCI5125_MODDIR}







