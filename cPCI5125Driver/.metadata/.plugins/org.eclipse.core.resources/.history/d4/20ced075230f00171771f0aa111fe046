################################################################################
#   Makefile for the HRcPCI3504 device driver (Linux)
################################################################################

PROJNAME:=HRcPCI3501
DEVFILE:=/dev/HRcPCI3501

ifneq ($(KERNELRELEASE),)

obj-m	   += HRcPCI3501.o
HRcPCI3501-objs := driver.o pci_io.o pci_init.o
EXTRA_CFLAGS += $(FIXUPFLAGS)

else

PATCHLEVEL:=$(shell uname -r | cut -d. -f2)
FIXUPFLAGS:=$(shell $(shell pwd)/fixupflags.sh)
HRCPCI3501_BOOT:=/etc/rc.d/init.d
HRCPCI3501_BOOT3:=/etc/rc.d/rc3.d/S50RcPCI3501
HRCPCI3501_BOOT5:=/etc/rc.d/rc5.d/S50RcPCI3501

EXTRA_CFLAGS += $(FIXUPFLAGS)
KDIR	:= /lib/modules/$(shell uname -r)/build
PWD	:= $(shell pwd)

ifeq ($(PATCHLEVEL), 4)
INSTRULES:=
UNINSTRULES:=
else
INSTRULES:=all
UNINSTRULES:=clean
endif

export FIXUPFLAGS

# Install paths
moduledir:= /lib/modules/$(shell uname -r)/

all:
        ifeq ($(PATCHLEVEL), 4)
		$(MAKE) -f Makefile2.4 $@
        else
		$(MAKE) -C $(KDIR) M=$(PWD) modules
        endif

clean:
        ifeq ($(PATCHLEVEL), 4)
		$(MAKE) -f Makefile2.4 $@
        else
		$(MAKE) -C $(KDIR) M=$(PWD) $@
        endif

install: $(INSTRULES)
        ifeq ($(PATCHLEVEL), 4)
		$(MAKE) -f Makefile2.4 $@
        else
#		all
		$(MAKE) -C $(KDIR) SUBDIRS=$(PWD) modules_install
		install -m0755 -p cpci3501_init ${HRCPCI3501_BOOT}/cpci3501_init
		install -m0755 -p cpci3501_load ${HRCPCI3501_BOOT}/cpci3501_load
		install -m0755 -p cpci3501_unload ${HRCPCI3501_BOOT}/cpci3501_unload
		ln -f -s ../init.d/cpci3501_init ${HRCPCI3501_BOOT3}
		ln -f -s ../init.d/cpci3501_init ${HRCPCI3501_BOOT5}
		sh ./cpci3501_load
        endif

uninstall: $(UNINSTRULES)
        ifeq ($(PATCHLEVEL), 4)
		$(MAKE) -f Makefile2.4 $@
        else
#		clean
		sh cpci3501_unload
		rm -f $(moduledir)/extra/$(PROJNAME).*
		rm -f ${HRCPCI3501_BOOT}/cpci3501_init
		rm -f ${HRCPCI3501_BOOT}/cpci3501_load
		rm -f ${HRCPCI3501_BOOT}/cpci3501_unload
		rm -f ${HRCPCI3501_BOOT3}
		rm -f ${HRCPCI3501_BOOT5}
        endif
		
default:
        ifeq ($(PATCHLEVEL), 4)
		$(MAKE) -f Makefile2.4 $@
        else
		$(MAKE) -C $(KDIR) M=$(PWD) modules
        endif
	

endif
