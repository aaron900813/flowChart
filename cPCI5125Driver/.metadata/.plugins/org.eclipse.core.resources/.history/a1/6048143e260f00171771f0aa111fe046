###########################################################################
#   Makefile for the cPCI5125 device driver (Linux)
###########################################################################

FIXUPFLAGS:=$(shell ./fixupflags.sh)
KERNELREV=$(shell uname -r)
KERNELBASE=/lib/modules/$(KERNELREV)
KERNELSRC=$(KERNELBASE)/build
INCLUDEDIR=$(KERNELSRC)/include
VERSION_FILE=/usr/include/linux/version.h
cPCI5125_MODDIR=$(KERNELBASE)/cPCI5125
cPCI5125_BOOT:=/etc/rc.d/init.d
cPCI5125_BOOT3:=/etc/rc.d/rc3.d/S50cPCI5125
cPCI5125_BOOT5:=/etc/rc.d/rc5.d/S50cPCI5125


# Extract version number from headers
VER = -DKERN$(shell awk '/LINUX/ {printf("%X", $$3/256)}' $(VERSION_FILE) )

CFLAGS = -D__KERNEL__ -DMODULE -DMODVERSIONS $(VER) -DEXPORT_SYMTAB -O -Wall \
         -I$(INCLUDEDIR) \
         -include $(KERNELSRC)/include/linux/modversions.h \
         $(FIXUPFLAGS)

# What we are building
OBJS = cPCI5125.o

HFILES = cpci5125driverlnx.h 
   

all: $(OBJS)

cPCI5125.o: cpci5125driverlnx.o
	$(LD) -r $^ -o $@

cpci5125driverlnx.o:   $(HFILES) Makefile cpci5125driverlnx.c

install: all
	install -d ${cPCI5125_MODDIR}
	install -m0644 -p cPCI5125.o ${cPCI5125_MODDIR}
	install -m0755 -p cpci3501_init ${cPCI5125_BOOT}/rfm2g_init
	install -m0755 -p cpci3501_load ${cPCI5125_BOOT}/rfm2g_load
	install -m0755 -p cpci3501_unload ${cPCI5125_BOOT}/rfm2g_unload
	ln -f -s ../init.d/cpci3501_init ${cPCI5125_BOOT3}
	ln -f -s ../init.d/cpci3501_init ${cPCI5125_BOOT5}
	sh ../cpci3501_load

# Clean up intermediate files
clean:
	rm -f *.o core
#
uninstall: clean
	sh cpci3501_unload
	rm -f ${cPCI5125_MODDIR}/cPCI5125.o
	rm -f ${cPCI5125_BOOT3}
	rm -f ${cPCI5125_BOOT5}
	rm -f ${cPCI5125_BOOT}/cpci3501_init
	rm -f ${cPCI5125_BOOT}/cpci3501_load
	rm -f ${cPCI5125_BOOT}/cpci3501_unload
	rmdir ${cPCI5125_MODDIR}







